{"version":3,"sources":["../src/index.js"],"names":["run","fileCopySync","src","dest","writeFileSync","readFileSync","getCliPath","binPath","process","mainModule","filename","indexOf","resolve","cwd","getBabelPath","getKoahubPath","getRuntimeFile","file","appName","runtimeName","replace","walk","dir","exist","existsSync","files","readdirSync","list","statSync","isDirectory","concat","push","mkdirsSync","dirname","mode","mkdirSync","compileByBabel","runtimeFile","content","babel","require","data","transform","presets","plugins","code","checkFileExtensions","extensions","regExp","validate","key","RegExp","test","checkFilesChange","changedFiles","mTimeApp","mtime","getTime","mTimeRuntime","version","command","description","option","action","script","options","rootPath","app","appPath","appFile","runtime","runtimePath","cliPath","watch","startRuntimeProcess","runtimeProcess","fork","on","signal","connected","exit","stopRuntimeProcess","kill","compile","err","time","Date","filePath","newTime","timeOut","setTimeout","length","clearTimeout","destFile","normalize","srcFile","project","exec","renameSync","parse","argv","args","help","argvs","argvt","split"],"mappings":"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","file":"index.js","sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport child_process from \"child_process\";\nimport shell from \"shelljs\";\nimport program from \"commander\";\nimport watch from \"./util/watch.util\";\nimport log, {debug} from \"./util/log.util\";\nimport config from \"./config/index.config\";\nimport packageFile from \"./../package.json\";\n\nfunction fileCopySync(src, dest) {\n    fs.writeFileSync(dest, fs.readFileSync(src));\n}\n\nfunction getCliPath() {\n\n    let binPath;\n    if (process.mainModule.filename.indexOf('koahub-cli') != -1) {\n        binPath = path.resolve(process.mainModule.filename, '../../');\n    } else {\n        binPath = path.resolve(process.cwd(), 'node_modules/koahub-cli');\n    }\n\n    return binPath;\n}\n\nfunction getBabelPath() {\n    return path.resolve('node_modules/.bin/babel');\n}\n\nfunction getKoahubPath() {\n    return path.resolve('node_modules/.bin/koahub');\n}\n\nfunction getRuntimeFile(file, appName, runtimeName) {\n    return file.replace(`${appName}`, `${runtimeName}`);\n}\n\nfunction walk(dir) {\n\n    const exist = fs.existsSync(dir);\n    if (!exist) {\n        return;\n    }\n\n    const files = fs.readdirSync(dir);\n    let list = [];\n\n    for (let file of files) {\n        if (fs.statSync(path.resolve(dir, file)).isDirectory()) {\n            list = list.concat(walk(path.resolve(dir, file)));\n        } else {\n            list.push(path.resolve(dir, file));\n        }\n    }\n\n    return list;\n}\n\nfunction mkdirsSync(dirname, mode) {\n    if (fs.existsSync(dirname)) {\n        return true;\n    } else {\n        if (mkdirsSync(path.dirname(dirname), mode)) {\n            fs.mkdirSync(dirname, mode);\n            return true;\n        }\n    }\n}\n\nfunction compileByBabel(file, appName, runtimeName) {\n\n    let runtimeFile = getRuntimeFile(file, appName, runtimeName);\n    mkdirsSync(path.dirname(runtimeFile));\n\n    let content = fs.readFileSync(file);\n    let babel = require('babel-core');\n    let data = babel.transform(content, {\n        filename: file,\n        presets: ['es2015', 'stage-3'],\n        plugins: ['transform-runtime']\n    });\n\n    fs.writeFileSync(`${runtimeFile}`, data.code);\n\n    log(`[Babel] ${file}`);\n}\n\nfunction checkFileExtensions(file) {\n    const extensions = ['.js', '.jsx', '.es6', '.es'];\n    let regExp, validate = false;\n    for (let key in extensions) {\n        regExp = new RegExp(`${extensions[key]}$`);\n        if (regExp.test(file)) {\n            validate = true;\n        }\n    }\n    return validate;\n}\n\nfunction checkFilesChange(appName, runtimeName) {\n\n    let changedFiles = [];\n    let files = walk(appName);\n\n    for (let key in files) {\n        if (!checkFileExtensions(files[key])) {\n            continue;\n        }\n        let mTimeApp = fs.statSync(files[key]).mtime.getTime();\n        let runtimeFile = getRuntimeFile(files[key], appName, runtimeName);\n\n        if (fs.existsSync(runtimeFile)) {\n            let mTimeRuntime = fs.statSync(runtimeFile).mtime.getTime();\n            if (mTimeRuntime < mTimeApp) {\n                changedFiles.push(files[key]);\n            }\n        } else {\n            changedFiles.push(files[key]);\n        }\n    }\n\n    return changedFiles;\n}\n\n\nprogram\n    .version(packageFile.version)\n\nprogram\n    .command('start [script]')\n    .description('koahub start script --watch --compile')\n    .option('-w, --watch', 'auto restart when a file is modified')\n    .option('-c, --compile', 'auto babel process when a file is modified')\n    .option('-r, --runtime [dir]', 'Babel compile and start the dir')\n    .action(function (script, options) {\n\n        const rootPath = process.cwd();\n        const appName = path.dirname(script) || config.app;\n        const appPath = path.resolve(rootPath, appName);\n        const appFile = path.resolve(rootPath, script);\n        const runtimeName = options.runtime || config.runtime;\n        const runtimePath = path.resolve(rootPath, runtimeName);\n        const runtimeFile = path.resolve(rootPath, getRuntimeFile(script, appName, runtimeName));\n\n        const cliPath = getCliPath();\n\n        // 监控启动\n        if (options.watch) {\n\n            // 编译并且监控启动\n            if (options.compile) {\n                const changedFiles = checkFilesChange(appName, runtimeName);\n                for (let key in changedFiles) {\n                    compileByBabel(changedFiles[key], appName, runtimeName);\n                }\n            }\n\n            let runtimeProcess;\n\n            function startRuntimeProcess(runtimeFile) {\n                runtimeProcess = child_process.fork(runtimeFile);\n                runtimeProcess.on('exit', function (code, signal) {\n                    if (runtimeProcess.connected == false) {\n                        process.exit();\n                    }\n                });\n            }\n\n            function stopRuntimeProcess() {\n                if (runtimeProcess) runtimeProcess.kill();\n            }\n\n            // 启动运行时进程\n            startRuntimeProcess(runtimeFile);\n\n            // 捕获SIGTERM退出信号\n            process.on('SIGTERM', function () {\n                stopRuntimeProcess();\n                process.exit();\n            });\n\n            // 捕获未知错误\n            process.on('uncaughtException', function (err) {\n                debug(err);\n            });\n\n            let time = new Date();\n            let files = [];\n            // 开启文件监控\n            watch(appName, runtimeName, function (filePath, compile = true) {\n\n                if (options.compile == true && compile == true) {\n                    files.push(filePath);\n                }\n\n                let newTime = new Date();\n                let timeOut = setTimeout(function () {\n                    if (files.length) {\n                        for (let key in files) {\n                            compileByBabel(files[key], appName, runtimeName);\n                        }\n                        // 未编译文件清空\n                        files = [];\n                    }\n                    // 进程退出\n                    stopRuntimeProcess();\n                    // 进程启动\n                    startRuntimeProcess(runtimeFile);\n                }, 100);\n\n                if (newTime - time <= 100) {\n                    clearTimeout(timeOut);\n                }\n\n                time = newTime;\n            });\n\n            return;\n        }\n\n        // 直接编译启动\n        if (options.compile) {\n            const changedFiles = checkFilesChange(appName, runtimeName);\n            for (let key in changedFiles) {\n                compileByBabel(changedFiles[key], appName, runtimeName);\n            }\n        }\n\n        // 直接启动\n        require(runtimeFile);\n    });\n\nprogram\n    .command('controller [file]')\n    .description('koahub create controller')\n    .action(function (file) {\n\n        const destFile = path.normalize(`${file}.controller.js`);\n        const srcFile = path.resolve(getCliPath(), 'template/controller/index.controller.js');\n\n        fileCopySync(srcFile, destFile);\n    });\n\nprogram\n    .command('create [project]')\n    .description('koahub create project')\n    .action(function (project) {\n\n        shell.exec('git clone https://github.com/einsqing/koahubjs-demo.git');\n        fs.renameSync(path.resolve('koahubjs-demo'), path.resolve(project));\n    });\n\n// mainMoule路径中含有koahub-cli为命令行启动\nif (process.mainModule.filename.indexOf('koahub-cli') != -1) {\n    program.parse(process.argv);\n    if (!program.args.length) program.help();\n}\n\n// 支持导入koahub-cli启动\nexport function run(argv) {\n\n    if (!argv) {\n        program.help();\n        return;\n    }\n\n    let argvs = [];\n    argvs.push(process.argv[0]);\n    argvs.push(getKoahubPath());\n\n    if (argv.indexOf(' ') != -1) {\n        const argvt = argv.split(' ');\n        for (let key in argvt) {\n            argvs.push(argvt[key]);\n        }\n    } else {\n        argvs.push(argv);\n    }\n\n    program.parse(argvs);\n}\n"]}