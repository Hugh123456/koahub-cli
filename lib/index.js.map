{"version":3,"sources":["../src/index.js"],"names":["fileCopySync","src","dest","writeFileSync","readFileSync","version","command","description","option","action","script","options","rootPath","process","cwd","appName","dirname","app","appPath","resolve","appFile","runtimeName","runtime","runtimePath","runtimeFile","replace","binPath","mainModule","filename","babel","watch","startRuntimeProcess","notify","title","message","icon","runtimeProcess","fork","on","code","signal","connected","exit","stopRuntimeProcess","kill","compile","exec","normalize","err","time","Date","files","filePath","fileRuntimePath","push","newTime","timeOut","setTimeout","length","key","clearTimeout","require","file","destFile","srcFile","project","renameSync","parse","argv","args","help"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;;;AAEA,SAASA,YAAT,CAAsBC,GAAtB,EAA2BC,IAA3B,EAAiC;AAC7B,iBAAGC,aAAH,CAAiBD,IAAjB,EAAuB,aAAGE,YAAH,CAAgBH,GAAhB,CAAvB;AACH;;AAED,oBACKI,OADL,CACa,kBAAYA,OADzB;;AAGA,oBACKC,OADL,CACa,gBADb,EAEKC,WAFL,CAEiB,uCAFjB,EAGKC,MAHL,CAGY,aAHZ,EAG2B,sCAH3B,EAIKA,MAJL,CAIY,eAJZ,EAI6B,4CAJ7B,EAKKA,MALL,CAKY,qBALZ,EAKmC,iCALnC,EAMKC,MANL,CAMY,UAASC,MAAT,EAAiBC,OAAjB,EAA0B;;AAE9B,QAAMC,WAAWC,QAAQC,GAAR,EAAjB;AACA,QAAMC,UAAU,eAAKC,OAAL,CAAaN,MAAb,KAAwB,gBAAOO,GAA/C;AACA,QAAMC,UAAU,eAAKC,OAAL,CAAaP,QAAb,EAAuBG,OAAvB,CAAhB;AACA,QAAMK,UAAU,eAAKD,OAAL,CAAaP,QAAb,EAAuBF,MAAvB,CAAhB;AACA,QAAMW,cAAcV,QAAQW,OAAR,IAAmB,gBAAOA,OAA9C;AACA,QAAMC,cAAc,eAAKJ,OAAL,CAAaP,QAAb,EAAuBS,WAAvB,CAApB;AACA,QAAMG,cAAc,eAAKL,OAAL,CAAaP,QAAb,EAAuBF,OAAOe,OAAP,MAAkBV,OAAlB,OAAgCM,WAAhC,CAAvB,CAApB;;AAEA,QAAMK,UAAU,eAAKP,OAAL,CAAaN,QAAQc,UAAR,CAAmBC,QAAhC,EAA0C,QAA1C,CAAhB;AACA,QAAMC,QAAQ,eAAKV,OAAL,CAAa,yBAAb,CAAd;;AAEA;AACA,QAAIR,QAAQmB,KAAZ,EAAmB;AAAA;AAAA,gBASNC,mBATM,GASf,SAASA,mBAAT,CAA6BP,WAA7B,EAA0C;AACtC,uCAASQ,MAAT,CAAgB;AACZC,2BAAO,WADK;AAEZC,6BAAS,MAFG;AAGZC,0BAAM,eAAKhB,OAAL,CAAaO,OAAb,EAAsB,gBAAtB;AAHM,iBAAhB;AAKAU,iCAAiB,wBAAcC,IAAd,CAAmBb,WAAnB,CAAjB;AACAY,+BAAeE,EAAf,CAAkB,MAAlB,EAA0B,UAASC,IAAT,EAAeC,MAAf,EAAuB;AAC7C,wBAAIJ,eAAeK,SAAf,IAA4B,KAAhC,EAAuC;AACnC5B,gCAAQ6B,IAAR;AACH;AACJ,iBAJD;AAKH,aArBc;;AAAA,gBAuBNC,kBAvBM,GAuBf,SAASA,kBAAT,GAA8B;AAC1B,oBAAIP,cAAJ,EAAoBA,eAAeQ,IAAf;AACvB,aAzBc;;AA2Bf;;;AAzBA;AACA,gBAAIjC,QAAQkC,OAAZ,EAAqB;AACjB,kCAAMC,IAAN,CAAW,eAAKC,SAAL,CAAkBlB,KAAlB,SAA2Bd,OAA3B,mBAAgDM,WAAhD,CAAX;AACH;;AAED,gBAAIe,uBAAJ;;AAqBAL,gCAAoBP,WAApB;;AAEA;AACAX,oBAAQyB,EAAR,CAAW,SAAX,EAAsB,YAAW;AAC7BK;AACA9B,wBAAQ6B,IAAR;AACH,aAHD;;AAKA;AACA7B,oBAAQyB,EAAR,CAAW,mBAAX,EAAgC,UAASU,GAAT,EAAc;AAC1C,gCAAMA,GAAN;AACH,aAFD;;AAIA,gBAAIC,OAAO,IAAIC,IAAJ,EAAX;AACA,gBAAIC,QAAQ,EAAZ;AACA;AACA,iCAAMpC,OAAN,EAAeM,WAAf,EAA4B,UAAS+B,QAAT,EAAmC;AAAA,oBAAhBP,OAAgB,yDAAN,IAAM;;;AAE3D,oBAAIlC,QAAQkC,OAAR,IAAmB,IAAnB,IAA2BA,WAAW,IAA1C,EAAgD;AAC5C,wBAAIQ,kBAAkBD,SAAS3B,OAAT,MAAoBV,OAApB,OAAkCM,WAAlC,CAAtB;AACA8B,0BAAMG,IAAN,CAAW,EAAEF,UAAUA,QAAZ,EAAsBC,iBAAiBA,eAAvC,EAAX;AACH;;AAED,oBAAIE,UAAU,IAAIL,IAAJ,EAAd;AACA,oBAAIM,UAAUC,WAAW,YAAW;AAChC,wBAAIN,MAAMO,MAAV,EAAkB;AACd,6BAAK,IAAIC,GAAT,IAAgBR,KAAhB,EAAuB;AACnB,8CAAML,IAAN,CAAW,eAAKC,SAAL,CAAkBlB,KAAlB,SAA2BsB,MAAMQ,GAAN,EAAWP,QAAtC,oBAA6DD,MAAMQ,GAAN,EAAWN,eAAxE,CAAX;AACH;AACD;AACAF,gCAAQ,EAAR;AACH;AACD;AACAR;AACA;AACAZ,wCAAoBP,WAApB;AACH,iBAZa,EAYX,GAZW,CAAd;;AAcA,oBAAI+B,UAAUN,IAAV,IAAkB,GAAtB,EAA2B;AACvBW,iCAAaJ,OAAb;AACH;;AAEDP,uBAAOM,OAAP;AACH,aA3BD;;AA6BA;AAAA;AAAA;AAzEe;;AAAA;AA0ElB;;AAED;AACA,QAAI5C,QAAQkC,OAAZ,EAAqB;AACjB,0BAAMC,IAAN,CAAW,eAAKC,SAAL,CAAkBlB,KAAlB,SAA2Bd,OAA3B,mBAAgDM,WAAhD,CAAX;AACH;;AAED;AACAwC,YAAQrC,WAAR;AACH,CAvGL;;AAyGA,oBACKlB,OADL,CACa,mBADb,EAEKC,WAFL,CAEiB,0BAFjB,EAGKE,MAHL,CAGY,UAASqD,IAAT,EAAe;;AAEnB,QAAMC,WAAW,eAAKhB,SAAL,CAAkBe,IAAlB,oBAAjB;AACA,QAAME,UAAU,eAAKjB,SAAL,CAAe,eAAK5B,OAAL,CAAaO,OAAb,EAAsB,yCAAtB,CAAf,CAAhB;;AAEA1B,iBAAagE,OAAb,EAAsBD,QAAtB;AACH,CATL;;AAWA,oBACKzD,OADL,CACa,kBADb,EAEKC,WAFL,CAEiB,uBAFjB,EAGKE,MAHL,CAGY,UAASwD,OAAT,EAAkB;;AAEtB,sBAAMnB,IAAN,CAAW,yDAAX;AACA,iBAAGoB,UAAH,CAAc,eAAK/C,OAAL,CAAa,eAAb,CAAd,EAA6C,eAAKA,OAAL,CAAa8C,OAAb,CAA7C;AACH,CAPL;;AASA,oBAAQE,KAAR,CAActD,QAAQuD,IAAtB;;AAEA,IAAI,CAAC,oBAAQC,IAAR,CAAaX,MAAlB,EAA0B,oBAAQY,IAAR","file":"index.js","sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport child_process from \"child_process\";\nimport shell from \"shelljs\";\nimport program from \"commander\";\nimport notifier from \"node-notifier\";\nimport watch from \"./util/watch.util\";\nimport { debug } from \"./util/log.util\";\nimport config from \"./config/index.config\";\nimport packageFile from \"./../package.json\";\n\nfunction fileCopySync(src, dest) {\n    fs.writeFileSync(dest, fs.readFileSync(src));\n}\n\nprogram\n    .version(packageFile.version)\n\nprogram\n    .command('start [script]')\n    .description('koahub start script --watch --compile')\n    .option('-w, --watch', 'auto restart when a file is modified')\n    .option('-c, --compile', 'auto babel process when a file is modified')\n    .option('-r, --runtime [dir]', 'Babel compile and start the dir')\n    .action(function(script, options) {\n\n        const rootPath = process.cwd();\n        const appName = path.dirname(script) || config.app;\n        const appPath = path.resolve(rootPath, appName);\n        const appFile = path.resolve(rootPath, script);\n        const runtimeName = options.runtime || config.runtime;\n        const runtimePath = path.resolve(rootPath, runtimeName);\n        const runtimeFile = path.resolve(rootPath, script.replace(`${appName}`, `${runtimeName}`));\n\n        const binPath = path.resolve(process.mainModule.filename, '../../');\n        const babel = path.resolve('node_modules/.bin/babel');\n\n        // 监控启动\n        if (options.watch) {\n\n            // 编译并且监控启动\n            if (options.compile) {\n                shell.exec(path.normalize(`${babel} ${appName} --out-dir ${runtimeName}`));\n            }\n\n            let runtimeProcess;\n\n            function startRuntimeProcess(runtimeFile) {\n                notifier.notify({\n                    title: 'KoaHub.js',\n                    message: '启动成功',\n                    icon: path.resolve(binPath, 'icons/info.png')\n                });\n                runtimeProcess = child_process.fork(runtimeFile);\n                runtimeProcess.on('exit', function(code, signal) {\n                    if (runtimeProcess.connected == false) {\n                        process.exit();\n                    }\n                });\n            }\n\n            function stopRuntimeProcess() {\n                if (runtimeProcess) runtimeProcess.kill();\n            }\n\n            // 启动运行时进程\n            startRuntimeProcess(runtimeFile);\n\n            // 捕获SIGTERM退出信号\n            process.on('SIGTERM', function() {\n                stopRuntimeProcess();\n                process.exit();\n            });\n\n            // 捕获未知错误\n            process.on('uncaughtException', function(err) {\n                debug(err);\n            });\n\n            let time = new Date();\n            let files = [];\n            // 开启文件监控\n            watch(appName, runtimeName, function(filePath, compile = true) {\n\n                if (options.compile == true && compile == true) {\n                    let fileRuntimePath = filePath.replace(`${appName}`, `${runtimeName}`);\n                    files.push({ filePath: filePath, fileRuntimePath: fileRuntimePath });\n                }\n\n                let newTime = new Date();\n                let timeOut = setTimeout(function() {\n                    if (files.length) {\n                        for (let key in files) {\n                            shell.exec(path.normalize(`${babel} ${files[key].filePath} --out-file ${files[key].fileRuntimePath}`));\n                        }\n                        // 未编译文件清空\n                        files = [];\n                    }\n                    // 进程退出\n                    stopRuntimeProcess();\n                    // 进程启动\n                    startRuntimeProcess(runtimeFile);\n                }, 100);\n\n                if (newTime - time <= 100) {\n                    clearTimeout(timeOut);\n                }\n\n                time = newTime;\n            });\n\n            return;\n        }\n\n        // 直接编译启动\n        if (options.compile) {\n            shell.exec(path.normalize(`${babel} ${appName} --out-dir ${runtimeName}`));\n        }\n\n        // 直接启动\n        require(runtimeFile);\n    });\n\nprogram\n    .command('controller [file]')\n    .description('koahub create controller')\n    .action(function(file) {\n\n        const destFile = path.normalize(`${file}.controller.js`);\n        const srcFile = path.normalize(path.resolve(binPath, 'template/controller/index.controller.js'));\n\n        fileCopySync(srcFile, destFile);\n    });\n\nprogram\n    .command('create [project]')\n    .description('koahub create project')\n    .action(function(project) {\n\n        shell.exec('git clone https://github.com/einsqing/koahubjs-demo.git');\n        fs.renameSync(path.resolve('koahubjs-demo'), path.resolve(project));\n    });\n\nprogram.parse(process.argv);\n\nif (!program.args.length) program.help();\n"]}